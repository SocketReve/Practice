/*! Practice Grunt 10-12-2014 */
angular.module("PracticeSimulator").service("PracticeCOMPFunctions",function(){var PracticeCOMPFunctions={};return PracticeCOMPFunctions.SUM=function(array){for(var somma=0,i=0;i<array.length;i++)somma+=array[i];return somma},PracticeCOMPFunctions.MIN=function(array){for(var minore=array[0],i=0;i<array.length;i++)array[i]<minore&&(minore=array[i]);return minore},PracticeCOMPFunctions.MAX=function(array){for(var maggiore=array[0],i=0;i<array.length;i++)array[i]>maggiore&&(maggiore=array[i]);return maggiore},PracticeCOMPFunctions}),angular.module("PracticeSimulator").factory("Graph2",function($q,$timeout,$window,$sanitize){function getNodeHTMLLabel(id,description,type,provider,mem,pmal,func,calculatedRisk){var htmlTemplate="<div class='customNode'>";return htmlTemplate+="<span class='type "+$sanitize(type)+"'> </span>",htmlTemplate+="<span class='calcRisk'> "+$sanitize(calculatedRisk)+" </span>",htmlTemplate+="<span class='name'>"+camelCase($sanitize(id))+"</span>",htmlTemplate+="<span class='description'>"+$sanitize(description)+"</span>",htmlTemplate+="<span class='provider'>"+$sanitize(provider.toUpperCase())+"</span>",htmlTemplate+="<span class='mem'>"+$sanitize(mem)+("COMP"==type?" | "+$sanitize(func):"")+"</span>",htmlTemplate+="<span class='pmal'>"+$sanitize(pmal)+"</span>",htmlTemplate+="</div>"}function camelCase(input){return input.replace(/ (.)/g,function(match,group1){return group1.toUpperCase()})}var g,renderer,zoom,svg,layout,model,scale=.85,scaleOnParameter=.8,initialized=!1,Graph=function(){var defer=$q.defer();return angular.element(document).ready(function(){defer.resolve(),svg=d3.select("svg");{var centerG=svg.append("g");centerG.append("g")}zoom=dagreD3.zoom.panAndZoom(d3.select("svg g g")),renderer=new dagreD3.Renderer,dagreD3.zoom(svg,zoom),layout=dagreD3.layout().nodeSep(70).rankSep(100),g=new dagreD3.Digraph({multigraph:!0});var oldDrawEdgePath=renderer.drawEdgePaths();renderer.drawEdgePaths(function(graph,root){var svgEdges=oldDrawEdgePath(graph,root);return svgEdges.attr("id",function(edge){return edge}),svgEdges.attr("time",function(edge){return g.edge(edge).label}),svgEdges.attr("from",function(edge){return g.edge(edge).from}),svgEdges.attr("to",function(edge){return g.edge(edge).to}),svgEdges.attr("class",function(edge){return"edgePath enter "+(g.edge(edge).highlight?"green":"")+" "+g.edge(edge).type}),svgEdges});var oldDrawNodes=renderer.drawNodes();renderer.drawNodes(function(graph,root){var svgNodes=oldDrawNodes(graph,root);return svgNodes.attr("id",function(u){return u}),svgNodes.select("rect").attr("class",function(u){return g.node(u).highlight?"green":""}),svgNodes});var oldDrawEdgeLabels=renderer.drawEdgeLabels();renderer.drawEdgeLabels(function(graph,root){var svgLabel=oldDrawEdgeLabels(graph,root);return svgLabel.attr("id",function(edge){return edge}),svgLabel}),renderer.layout(layout)}),angular.element($window).bind("resize",function(){Graph.resize()}),defer.promise};return Graph.isInitialized=function(){return initialized},Graph.getRawNode=function(node){return g.node(node)},Graph.getRawEdge=function(edge){return g.edge(edge)},Graph.getEdges=function(){var edgesName=g.edges(),edges=[];return edgesName.forEach(function(e){edges.push({id:e,value:g.edge(e)})}),edges},Graph.getNodes=function(){var nodesName=g.nodes(),nodes=[];return nodesName.forEach(function(u){nodes.push({id:u,value:g.node(u)})}),nodes},Graph.setEdgeLabel=function(id,label){g.edge(id).label=label.toString()},Graph.setEdgeType=function(id,type){g.edge(id).type=type},Graph.setNodeDescription=function(id,description){var temp=g.node(id);g.node(id).descr=description,g.node(id).label=getNodeHTMLLabel(id,description,temp.type,temp.provider,temp.mem,temp.pmal,temp.func,temp.calculatedRisk)},Graph.setNodeMem=function(id,value,stringValue){var temp=g.node(id);g.node(id).mem=parseInt(value),g.node(id).label=getNodeHTMLLabel(id,temp.descr,temp.type,temp.provider,stringValue,temp.pmal,temp.func,temp.calculatedRisk)},Graph.setNodeProvider=function(id,provider){var temp=g.node(id);g.node(id).provider=provider,g.node(id).label=getNodeHTMLLabel(id,temp.descr,temp.type,provider,temp.mem,temp.pmal,temp.func,temp.calculatedRisk)},Graph.setNodeType=function(id,type){var temp=g.node(id);g.node(id).type=type,g.node(id).label=getNodeHTMLLabel(id,temp.descr,type,temp.provider,temp.mem,temp.pmal,temp.func,temp.calculatedRisk)},Graph.setNodeFunc=function(id,func){var temp=g.node(id);g.node(id).func=func,g.node(id).label=getNodeHTMLLabel(id,temp.descr,temp.type,temp.provider,temp.mem,temp.pmal,func,temp.calculatedRisk)},Graph.setNodePMAL=function(id,pmal){var temp=g.node(id);g.node(id).pmal=parseFloat(pmal),g.node(id).label=getNodeHTMLLabel(id,temp.descr,temp.type,temp.provider,temp.mem,pmal,temp.func,temp.calculatedRisk)},Graph.setNodeCalculatedRisk=function(id,calculatedRisk){var temp=g.node(id);g.node(id).calculatedRisk=parseFloat(calculatedRisk),g.node(id).label=getNodeHTMLLabel(id,temp.descr,temp.type,temp.provider,temp.mem,temp.pmal,temp.func,calculatedRisk)},Graph.resize=function(){var graphWidth=model.graph().width+5,graphHeight=model.graph().height+5,width=parseInt(svg.style("width").replace(/px/,"")),height=parseInt(svg.style("height").replace(/px/,"")),zoomScale=Math.min(width/graphWidth*scale,height/graphHeight*scale),translate=[width/2-graphWidth*zoomScale/2+10,height/2-graphHeight*zoomScale/2];zoom.translate(translate),zoom.scale(zoomScale),zoom.event(svg.transition().duration(500))},Graph.addNode=function(id,description,type,provider,mem,pmal,func,shares){0==initialized&&(initialized=!0,model=renderer.run(g,d3.select("svg g g")));try{g.addNode(camelCase(id.trim()),{labelType:"html",label:getNodeHTMLLabel(id,description,type,provider,mem,pmal,func,Number(0).toFixed(1)),descr:description,type:type,provider:provider.toUpperCase(),mem:parseInt(mem),pmal:parseFloat(pmal),func:func,calculatedRisk:Number(0).toFixed(1),highlight:!1,shares:shares})}catch(err){throw{message:"Node already in graph or input not valid",obj:err}}},Graph.addEdge=function(source,target,time,type,currentNumberOfShare){"SS"==type&&0==currentNumberOfShare&&(currentNumberOfShare=g.node(camelCase(source)).shares=g.node(camelCase(source)).shares+1);try{g.addEdge(camelCase(source)+"-"+camelCase(target)+"-"+time.toString()+"-"+currentNumberOfShare.toString(),camelCase(source),camelCase(target),{label:time.toString(),from:camelCase(source),to:camelCase(target),type:type,highlight:!1,shareNumber:currentNumberOfShare})}catch(err){throw g.node(camelCase(source)).shares=g.node(camelCase(source)).shares-1,{message:"Communication already in protocol or input not valid",obj:err}}},Graph.removeNode=function(id){try{g.delNode(id)}catch(err){throw{message:"Node not exists, input not valid or protocol cannot exist without nodes",obj:err}}},Graph.removeEdge=function(id){var source=g.edge(id).from,edgeType=g.edge(id).type;"SS"==edgeType&&(g.node(camelCase(source)).shares=g.node(camelCase(source)).shares-1);try{g.delEdge(id)}catch(err){throw{message:"Communication not exist",obj:err}}},Graph.redesign=function(){renderer.transition(function(selection){return selection.transition().duration(500)}),model=renderer.run(g,d3.select("svg g g"))},Graph.scale=function(scaleMod){var translate,graphWidth=model.graph().width+5,graphHeight=model.graph().height+5,width=parseInt(svg.style("width").replace(/px/,"")),height=parseInt(svg.style("height").replace(/px/,""));if("original"==scaleMod){var zoomScale=Math.min(width/graphWidth*scale,height/graphHeight*scale);translate=[width/2-graphWidth*zoomScale/2+10,height/2-graphHeight*zoomScale/2]}else if("parameters"==scaleMod){var zoomScale=Math.min(width/graphWidth*scaleOnParameter,height/graphHeight*scaleOnParameter),parametersWidth=document.getElementById("parameters").offsetWidth;translate=[parametersWidth+20,height/2-graphHeight*zoomScale/2]}zoom.translate(translate),zoom.scale(zoomScale),zoom.event(svg.transition().duration(500))},Graph.highlightEdge=function(edge,activate){g.edge(edge).highlight=1==activate?!0:!1},Graph.highlightNode=function(node,activate){g.node(node).highlight=1==activate?!0:!1},Graph.resetHighlight=function(){g.nodes().forEach(function(u){g.node(u).highlight=!1}),g.edges().forEach(function(e){g.edge(e).highlight=!1})},Graph}),angular.module("PracticeSimulator").factory("Practice",function($q,$interval,Graph2,PracticeCOMPFunctions){var nodes,instants,maxTime,rawElements,interval,actualTimeSimulation,matrixNodePerInstants,comTypeToTemplate={PT:[" "," "],SS:["[","]"],EN:["{","}"],GC:["","*"]},initialized=!1,Practice=function(){maxTime=0,initialized=!0,nodes={},instants={},matrixNodePerInstants=[],rawElements={nodes:Graph2.getNodes(),edges:Graph2.getEdges()};for(var i=0;i<rawElements.nodes.length;i++)nodes[rawElements.nodes[i].id]={ID:rawElements.nodes[i].id,IN:{length:function(){var key,size=0;for(key in this)this.hasOwnProperty(key)&&size++;return size-1}},OUT:{length:function(){var size=0;for(var key in this)this.hasOwnProperty(key)&&size++;return size-2}},TYPE:rawElements.nodes[i].value.type,PMAL:rawElements.nodes[i].value.pmal,PROVIDER:rawElements.nodes[i].value.provider,MEM:{array:"COMP"==rawElements.nodes[i].value.type||"RES"==rawElements.nodes[i].value.type?[]:[{value:rawElements.nodes[i].value.mem,comType:"PT",shareIndex:0,from:""}],value:rawElements.nodes[i].value.mem},FUNC:rawElements.nodes[i].value.func,SHARES:rawElements.nodes[i].value.shares};for(var i=0;i<rawElements.edges.length;i++)nodes[rawElements.edges[i].value.to].IN[rawElements.edges[i].value.from]=!0,nodes[rawElements.edges[i].value.from].OUT[rawElements.edges[i].value.to]=!0;for(var i=0;i<rawElements.edges.length;i++)parseInt(rawElements.edges[i].value.label)>maxTime&&(maxTime=parseInt(rawElements.edges[i].value.label));for(var j=0,i=0;i<rawElements.edges.length;i++){for(var k=0;k<rawElements.edges.length;k++)parseInt(rawElements.edges[k].value.label)==j&&(instants[j]instanceof Array||(instants[j]=[]),instants[j].push({IN:rawElements.edges[k].value.from,OUT:rawElements.edges[k].value.to,COMTYPE:rawElements.edges[k].value.type,EDGE:rawElements.edges[k].id,SHARENUMBER:rawElements.edges[k].value.shareNumber}));j++}};return Practice.getNodes=function(){return nodes},Practice.getInstants=function(){return instants},Practice.getTableNodePerInstants=function(){return matrixNodePerInstants},Practice.checkGraph=function(){for(key in nodes){if("RES"==nodes[key].TYPE&&nodes[key].OUT.length()>0)throw{message:"RES node '"+key+"' can't have any exit communication"};if("IN"==nodes[key].TYPE&&nodes[key].IN.length()>0)throw{message:"IN node '"+key+"' can't have any input edges"}}},Practice.runIntervalSimulation=function(intervalTime){var defer=$q.defer();return actualTimeSimulation=0,Graph2.resetHighlight(),interval=$interval(function(){Practice.simulationStep(defer)},intervalTime),defer.promise},Practice.runStepSimulation=function(){actualTimeSimulation=0,Graph2.resetHighlight(),Practice.simulationStep()},Practice.simulationStep=function(defer){try{if(actualTimeSimulation>0)for(var i=0;i<instants[actualTimeSimulation-1].length;i++)Graph2.highlightEdge(instants[actualTimeSimulation-1][i].EDGE,!1),Graph2.highlightNode(instants[actualTimeSimulation-1][i].IN,!1),Graph2.highlightNode(instants[actualTimeSimulation-1][i].OUT,!1)}catch(err){console.log("SIMULATION TIMER: Time step missing in de-highlighting")}try{for(var i=0;i<instants[actualTimeSimulation].length;i++)Graph2.highlightEdge(instants[actualTimeSimulation][i].EDGE,!0),Graph2.highlightNode(instants[actualTimeSimulation][i].IN,!0),Graph2.highlightNode(instants[actualTimeSimulation][i].OUT,!0);for(var mapArrayOfMemoriesOutput={},i=0;i<instants[actualTimeSimulation].length;i++)mapArrayOfMemoriesOutput[instants[actualTimeSimulation][i].OUT]instanceof Array||(mapArrayOfMemoriesOutput[instants[actualTimeSimulation][i].OUT]=[]),mapArrayOfMemoriesOutput[instants[actualTimeSimulation][i].OUT].push({value:nodes[instants[actualTimeSimulation][i].IN].MEM.value,comType:instants[actualTimeSimulation][i].COMTYPE,shareIndex:instants[actualTimeSimulation][i].SHARENUMBER,from:instants[actualTimeSimulation][i].IN});for(var node in mapArrayOfMemoriesOutput)if(nodes[node].MEM.array=nodes[node].MEM.array.concat(mapArrayOfMemoriesOutput[node]),"function"==typeof PracticeCOMPFunctions[nodes[node].FUNC]){var arrayOfValues=nodes[node].MEM.array.map(function(item){return item.value});nodes[node].MEM.value=PracticeCOMPFunctions[nodes[node].FUNC](arrayOfValues),Graph2.setNodeMem(node,nodes[node].MEM.value,Practice.compileMemoryToString(nodes[node].MEM.array))}else Graph2.setNodeMem(node,0,Practice.compileMemoryToString(nodes[node].MEM.array));Graph2.redesign()}catch(err){console.log(err),console.log("SIMULATION TIMER: Time step missing")}if(matrixNodePerInstants.push(angular.copy(nodes)),actualTimeSimulation==maxTime+1){if($interval.cancel(interval),"undefined"==typeof defer)return!1;defer.resolve()}actualTimeSimulation++},Practice.compileMemoryToString=function(mem){if("object"!=typeof mem[0])return mem.toString();for(var compiledMem="",i=0;i<mem.length;i++)compiledMem+=comTypeToTemplate[mem[i].comType][0]+mem[i].value.toString()+comTypeToTemplate[mem[i].comType][1]+("PT"!=mem[i].comType?"<sub>"+mem[i].shareIndex.toString()+"</sub>":"");return compiledMem},Practice.isInitialized=function(){return initialized},Practice}),angular.module("PracticeSimulator").service("PracticeSETOperations",function(){var PracticeSETOperations={};return PracticeSETOperations.PowerSet=function(o,w,e,r,s,E,t){for(r=[s=1<<(E=o.length)];s;)for(w=s.toString(2),e=t=w.length,r[--s]=[];e;)~-w[--e]||r[s].push(o[e+E-t]);return r},PracticeSETOperations}),angular.module("PracticeSimulator").factory("PracticeShapley",function(){var Shapley=function(nodes){function fattoriale(a){for(var f=1,i=1;a>=i;i+=1)f*=i;fat=f}function permute(pNum,pChar,index){if(pNum.length==index)LeggiVettore(pNum,pChar);else for(var i=index;i<pNum.length;i++){var input=pNum.slice(0),temp=input[i];input[i]=input[index],input[index]=temp;var input2=pChar.slice(0),temp2=input2[i];input2[i]=input2[index],input2[index]=temp2,permute(input,input2,index+1)}}function LeggiVettore(vettNumPerm,vettCharPerm){for(var i=0;i<vettNumPerm.length;i++){var fond=0;minBefore=Math.min(sumV1,sumV2);for(var j=0;j<vCharF.length;j++)if(vettCharPerm[i]==vCharF[j]){fond=1,sumV1+=vettNumPerm[i],min=Math.min(sumV1,sumV2),step=min-minBefore;for(var k=0;k<vChar.length;k++)vettCharPerm[i]==vChar[k]&&(vR[k]=vR[k]+step)}if(0==fond){sumV2+=vettNumPerm[i],min=Math.min(sumV1,sumV2),step=min-minBefore;for(var k=0;k<vChar.length;k++)vettCharPerm[i]==vChar[k]&&(vR[k]=vR[k]+step)}}sumV1=0,sumV2=0}var vChar=[],vNum=[],vCharF=[],fat=0,min=0,minBefore=0,step=0,sumV1=0,sumV2=0,vR=[],estimatedRiskPerNode=[];for(var node in nodes)vChar.push(node),vNum.push(nodes[node].PMAL),"COMP"==nodes[node].TYPE&&vCharF.push(node);if(0==vChar.length)return void console.log("Il vettore dei nodi è vuoto");if(0==vNum.length)return void console.log("Il vettore dei valori nodi è vuoto");if(0==vCharF.length)return void console.log("Il vettore dei nodi fondamentali è vuoto");if(vChar.length!=vNum.length)return void console.log("La lunghezza del vettore dei nodi ("+vChar.length+") è diversa dalla lunghezza del vettore dei valori dei nodi ("+vNum.length+")");for(var i=0;i<vChar.length;i++)vR[i]=0;fattoriale(vNum.length),permute(vNum,vChar,0);for(var i=0;i<vR.length;i++)vR[i]=vR[i]/fat;if(vChar.length!=vR.length)return void console.log("La lunghezza del vettore dei nodi ("+vChar.length+") è diversa dalla lunghezza del vettore dei valori di shapley dei nodi ("+vR.length+")");for(var i=0;i<vR.length;i++)estimatedRiskPerNode.push({id:vChar[i],risk:vR[i].toFixed(2)});return estimatedRiskPerNode};return Shapley}),angular.module("PracticeSimulator").controller("PracticeChartsController",function($scope,$modalInstance,$timeout,Practice,PracticeSETOperations){var powerSet,nodes=Practice.getNodes(),nodesArray=[];for(node in nodes)nodes.hasOwnProperty(node)&&nodesArray.push(nodes[node]);powerSet=PracticeSETOperations.PowerSet(nodesArray);for(var mappaProb={},nodesRanking=[],i=0;i<powerSet.length-1;i++){for(var name="",prob=1,j=0;j<powerSet[i].length;j++)name=name+(""!=name?"-":"")+powerSet[i][j].ID,prob*=powerSet[i][j].PMAL;prob=prob.toFixed(3),"undefined"==typeof mappaProb[powerSet[i].length]&&(mappaProb[powerSet[i].length]={}),"undefined"==typeof mappaProb[powerSet[i].length][prob]&&(mappaProb[powerSet[i].length][prob]=""),mappaProb[powerSet[i].length][prob]=""===mappaProb[powerSet[i].length][prob]?name:mappaProb[powerSet[i].length][prob]+" | "+name}for(var number in mappaProb)for(var p in mappaProb[number])mappaProb[number].hasOwnProperty(p)&&nodesRanking.push({name:mappaProb[number][p],y:parseFloat(p),x:parseInt(number)});$timeout(function(){var chart=new CanvasJS.Chart("practice-scatter-plot",{title:{text:"Probability of Collusion",fontFamily:"arial black",fontColor:"DarkSlateGrey",fontSize:15},axisX:{title:"Number of actors in coalition",titleFontFamily:"arial",titleFontSize:12,interval:1},axisY:{title:"Probability",titleFontFamily:"arial",titleFontSize:12},data:[{type:"scatter",color:"#17cf00",toolTipContent:"<span style='\"'color: {color};'\"'><strong>{name}</strong></span> <br/> <strong>Probability</strong> {y}<br/> <strong>Number of actors aggregates</strong> {x} ",dataPoints:nodesRanking}],zoomEnabled:!0});chart.render()},100),$scope.exit=function(){$modalInstance.dismiss("exit")}}),angular.module("PracticeSimulator").controller("PracticeMainController",function($scope,$modal,$interval,$timeout,$q,Graph2,Practice,PracticeCOMPFunctions,PracticeShapley){function customAlert(message){console.log(message),$scope.alert=!0,$scope.alertMessage=message.message,$scope.alertType="success"==message.type?"success":"danger",$timeout(function(){$scope.alert=!1,$scope.alertMessage=""},3e3)}function bindCustomEvents(){for(var nodesEvents=document.getElementsByClassName("node"),i=0;i<nodesEvents.length;i++)angular.element(nodesEvents[i]).off().on("click",function(){$scope.modifierIsNode=!0,$scope.modifierIsEdge=!1,$scope.showModifier(!0);var node=Graph2.getRawNode(this.id);$scope.nodeTypeModifier=node.type,$scope.nodeFuncModifier=node.func,$scope.nodeNameModifier=this.id,$scope.nodeDescriptionModifier=node.descr,$scope.nodeGroupModifier=node.provider,console.log(node),$scope.nodeMemModifier=node.mem,$scope.nodeMaliciousProbabilityModifier=node.pmal});for(var edgesEvents=document.getElementsByClassName("edgeLabel"),i=0;i<edgesEvents.length;i++)angular.element(edgesEvents[i]).off().on("click",function(){$scope.modifierIsNode=!1,$scope.modifierIsEdge=!0,$scope.showModifier(!0);var edge=Graph2.getRawEdge(this.id);$scope.edgeIdModifier=this.id,$scope.edgeLabelModifier=parseInt(edge.label),$scope.edgeTypeModifier=edge.type});angular.element(document).off("keydown"),angular.element(document).on("keydown",function(e){if(console.log(e),27==e.keyCode)$scope.showParameters(!1),$scope.showModifier(!1);else if(73==e.keyCode&&e.metaKey){$scope.showParameters(!0);var timeoutNodes,timeoutEdges,json={nodes:[{id:"I1",value:{descr:"fornitore di asfalto",type:"IN",provider:"-",mem:100,pmal:.8,calculatedRisk:"0.0",highlight:!1,shares:2}},{id:"I2",value:{descr:"fornitore di attrezzi",type:"IN",provider:"-",mem:50,pmal:.8,calculatedRisk:"0.0",highlight:!1,shares:2}},{id:"I3",value:{descr:"fornitore di macchine utensili",type:"IN",provider:"-",mem:20,pmal:.9,calculatedRisk:"0.0",highlight:!1,shares:2}},{id:"I4",value:{descr:"fornitore di asfalto",type:"IN",provider:"-",mem:95,pmal:.7,func:"",calculatedRisk:"0.0",highlight:!1,shares:2}},{id:"I5",value:{descr:"fornitore di attrezzi",type:"IN",provider:"-",mem:40,pmal:.6,calculatedRisk:"0.0",highlight:!1,shares:2}},{id:"I6",value:{descr:"fornitore di macchine utensili",type:"IN",provider:"-",mem:45,pmal:.6,calculatedRisk:"0.0",highlight:!1,shares:2}},{id:"C1",value:{descr:"primo offerente - 1",type:"COMP",provider:"-",mem:0,pmal:.4,func:"SUM",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"C2",value:{descr:"primo offerente - 2",type:"COMP",provider:"-",mem:0,pmal:.4,func:"SUM",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"C3",value:{descr:"secondo offerente - 1",type:"COMP",provider:"-",mem:0,pmal:.3,func:"SUM",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"C4",value:{descr:"secondo offerente - 2",type:"COMP",provider:"-",mem:0,pmal:.3,func:"SUM",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"C5",value:{descr:"primo offerente - 3",type:"COMP",provider:"provider sicuro",mem:0,pmal:.1,func:"SUM",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"C6",value:{descr:"secondo offerente - 3",type:"COMP",provider:"provider sicuro",mem:0,pmal:.1,func:"SUM",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"C7",value:{descr:"ente appaltante",type:"COMP",provider:"-",mem:0,pmal:.1,func:"MIN",calculatedRisk:"0.0",highlight:!1,shares:0}},{id:"R1",value:{descr:"agente",type:"RES",provider:"-",mem:0,pmal:.1,func:null,calculatedRisk:"0.0",highlight:!1,shares:0}}],edges:[{id:"I1-C1-0-1",value:{label:"0",from:"I1",to:"C1",type:"SS",highlight:!1,shareNumber:1}},{id:"I1-C2-0-2",value:{label:"0",from:"I1",to:"C2",type:"SS",highlight:!1,shareNumber:2}},{id:"I2-C1-0-1",value:{label:"0",from:"I2",to:"C1",type:"SS",highlight:!1,shareNumber:1}},{id:"I2-C2-0-2",value:{label:"0",from:"I2",to:"C2",type:"SS",highlight:!1,shareNumber:2}},{id:"I3-C1-0-1",value:{label:"0",from:"I3",to:"C1",type:"SS",highlight:!1,shareNumber:1}},{id:"I3-C2-0-2",value:{label:"0",from:"I3",to:"C2",type:"SS",highlight:!1,shareNumber:2}},{id:"I4-C3-0-1",value:{label:"0",from:"I4",to:"C3",type:"SS",highlight:!1,shareNumber:1}},{id:"I5-C3-0-1",value:{label:"0",from:"I5",to:"C3",type:"SS",highlight:!1,shareNumber:1}},{id:"I6-C3-0-1",value:{label:"0",from:"I6",to:"C3",type:"SS",highlight:!1,shareNumber:1}},{id:"I4-C4-0-1",value:{label:"0",from:"I4",to:"C4",type:"SS",highlight:!1,shareNumber:1}},{id:"I5-C4-0-2",value:{label:"0",from:"I5",to:"C4",type:"SS",highlight:!1,shareNumber:2}},{id:"I6-C4-0-2",value:{label:"0",from:"I6",to:"C4",type:"SS",highlight:!1,shareNumber:2}},{id:"C1-C5-1-0",value:{label:"1",from:"C1",to:"C5",type:"PT",highlight:!1,shareNumber:0}},{id:"C2-C5-1-0",value:{label:"1",from:"C2",to:"C5",type:"PT",highlight:!1,shareNumber:0}},{id:"C3-C6-1-1",value:{label:"1",from:"C3",to:"C6",type:"PT",highlight:!1,shareNumber:0}},{id:"C4-C6-1-0",value:{label:"1",from:"C4",to:"C6",type:"PT",highlight:!1,shareNumber:0}},{id:"C5-C7-2-0",value:{label:"2",from:"C5",to:"C7",type:"PT",highlight:!1,shareNumber:0}},{id:"C6-C7-2-0",value:{label:"2",from:"C6",to:"C7",type:"PT",highlight:!1,shareNumber:0}},{id:"C7-R1-3-0",value:{label:"3",from:"C7",to:"R1",type:"PT",highlight:!1,shareNumber:0}}]},i=0,j=0,e=0,timeTimeoutString=50,timeTimeoutValue=30,timeTimeoutStringCom=100,timeTimeoutValueCom=1e3,typeWriterEdges=function(edge){if(console.log(edge),e==json.edges.length-1)$timeout.cancel(timeoutEdges),$scope.showParameters(!1),$scope.simulationRunning=!0,new Practice,$scope.generateChart(),$timeout(function(){Practice.runIntervalSimulation(2e3).then(function(){$scope.simulationRunning=!1})},500),console.log("finito");else{var timeoutFrom,timeoutTo,timeoutTime,typeWriterFrom=function(char){if(console.log(char),$scope.fromNew+=char,i==edge.value.from.length-1){$timeout.cancel(timeoutFrom),i=0;var typeWriterTo=function(char){if(console.log(char),$scope.toNew+=char,i==edge.value.to.length-1){$timeout.cancel(timeoutTo),i=0;var typeWriterTime=function(actual,num){console.log(actual),$scope.timeNew=actual,actual==num?($timeout.cancel(typeWriterTime),i=0,$scope.edgeTypeNew=edge.value.type,$scope.addCommunication(),timeoutEdges=$timeout(function(){typeWriterEdges(json.edges[++e])},800)):timeoutTime=$timeout(function(){typeWriterTime(++actual,parseInt(edge.value.label))},timeTimeoutValueCom)};typeWriterTime(0,parseInt(edge.value.label))}else timeoutTo=$timeout(function(){typeWriterTo(edge.value.to[++i])},timeTimeoutStringCom)};typeWriterTo(edge.value.to[i])}else timeoutFrom=$timeout(function(){typeWriterFrom(edge.value.from[++i])},timeTimeoutStringCom)};typeWriterFrom(edge.value.from[i])}},typewriterNodes=function(node){if(console.log(node),j==json.nodes.length-1)$timeout.cancel(timeoutNodes),typeWriterEdges(json.edges[e]);else{var timeoutName,timeoutDescr,timeoutMem,timeoutPMAL,timeoutProvider;console.log(node);var typeWriterNodeName=function(char){if(console.log(char),$scope.nameNew+=char,i==node.id.length-1){$timeout.cancel(timeoutName),i=0;var typeWriterNodeDescr=function(char){if(console.log(char),$scope.descrizioneNew+=char,i==node.value.descr.length-1){$timeout.cancel(timeoutDescr),i=0;var typeWriterMem=function(actual,num){if(console.log(actual),$scope.memNew=actual,actual==num){$timeout.cancel(timeoutMem),i=0;var typeWriterPMAL=function(actual,num){if(console.log(actual),$scope.maliciousProbabilityNew=actual,actual==Number(num.toFixed(1))){$timeout.cancel(timeoutPMAL),i=0;var typeWriterProvider=function(char){console.log(char),$scope.providerNodeNew+=char,i==node.value.provider.length-1?($timeout.cancel(timeoutProvider),i=0,$scope.nodeTypeNew=node.value.type,$scope.nodeFunctionNew=node.value.func,$scope.addNode(),timeoutNodes=$timeout(function(){typewriterNodes(json.nodes[++j])},100)):timeoutProvider=$timeout(function(){typeWriterProvider(node.value.provider[++i])},timeTimeoutString)};typeWriterProvider(node.value.provider[i])}else timeoutPMAL=$timeout(function(){actual+=.1,typeWriterPMAL(Number(actual.toFixed(1)),node.value.pmal)},timeTimeoutValue)};typeWriterPMAL(0,node.value.pmal)}else timeoutMem=$timeout(function(){typeWriterMem(++actual,node.value.mem)},timeTimeoutValue)};typeWriterMem(0,node.value.mem)}else timeoutDescr=$timeout(function(){typeWriterNodeDescr(node.value.descr[++i])},timeTimeoutString)};typeWriterNodeDescr(node.value.descr[i])}else timeoutName=$timeout(function(){typeWriterNodeName(node.id[++i])},timeTimeoutString)};typeWriterNodeName(node.id[i])}};typewriterNodes(json.nodes[j])}})}$scope.nameNew="",$scope.descrizioneNew="",$scope.fromNew="",$scope.toNew="",$scope.memNew=0,$scope.timeNew=0,$scope.maliciousProbabilityNew=.1,$scope.providerNodeNew="",$scope.groupOfNodeNew="",$scope.newGroupName="",$scope.nodeGroupModifier="",$scope.nodeTypeNew="IN",$scope.edgeTypeNew="PT",$scope.nodeTypeModifier="COMP",$scope.nodeFuncModifier="",$scope.nodeFunctionNew="",$scope.nodeNameModifier="",$scope.nodeMemModifier=0,$scope.nodeMaliciousProbabilityModifier=.1,$scope.nodeDescriptionModifier="",$scope.edgeIdModifier="",$scope.edgeLabelModifier=0,$scope.edgeTypeModifier="",$scope.simulationRunning=!1,$scope.simulationStepRunning=!1,$scope.funcOfCompNode=[],$scope.alert=!1;for(var type in PracticeCOMPFunctions)$scope.funcOfCompNode.push(type);bindCustomEvents(),$scope.addNode=function(){if(""!=$scope.nameNew.trim()&&""!=$scope.descrizioneNew.trim()&&""!=$scope.providerNodeNew.trim())if(0==Graph2.isInitialized())(new Graph2).then(function(){try{Graph2.addNode($scope.nameNew.trim(),$scope.descrizioneNew.trim(),$scope.nodeTypeNew,$scope.providerNodeNew.trim(),$scope.memNew,$scope.maliciousProbabilityNew,$scope.nodeFunctionNew,0),$scope.nameNew="",$scope.descrizioneNew="",$scope.providerNodeNew="",$scope.memNew=0,$scope.maliciousProbabilityNew=.1,Graph2.redesign(),$timeout(function(){bindCustomEvents(),Graph2.scale("parameters")},500)}catch(err){customAlert(err)}});else try{Graph2.addNode($scope.nameNew.trim(),$scope.descrizioneNew.trim(),$scope.nodeTypeNew,$scope.providerNodeNew.trim(),$scope.memNew,$scope.maliciousProbabilityNew,$scope.nodeFunctionNew,0),$scope.nameNew="",$scope.descrizioneNew="",$scope.providerNodeNew="",$scope.memNew=0,$scope.maliciousProbabilityNew=.1,Graph2.redesign(),$timeout(function(){bindCustomEvents(),Graph2.scale("parameters")},500)}catch(err){customAlert(err)}else customAlert("Not compiled all input form")},$scope.addCommunication=function(){if(""!=$scope.fromNew.trim()&&""!=$scope.toNew.trim())try{Graph2.addEdge($scope.fromNew.trim(),$scope.toNew.trim(),$scope.timeNew,$scope.edgeTypeNew,0),$scope.fromNew="",$scope.toNew="",$scope.timeNew=0,Graph2.redesign(),$timeout(function(){bindCustomEvents(),Graph2.scale("parameters")},500)}catch(err){customAlert(err)}else customAlert("Not compiled all input form")},$scope.showModifier=function(condition){1==condition?angular.element(document.getElementById("modifier")).removeClass("hide"):angular.element(document.getElementById("modifier")).addClass("hide")},$scope.showParameters=function(condition){1==condition?(angular.element(document.getElementById("parameters")).addClass("slideRight"),Graph2.isInitialized()&&$timeout(function(){Graph2.scale("parameters")},300)):angular.element(document.getElementById("parameters")).hasClass("slideRight")&&(angular.element(document.getElementById("parameters")).removeClass("slideRight"),Graph2.isInitialized()&&Graph2.scale("original"))},$scope.resetZoom=function(){Graph2.resize()},$scope.reloadPage=function(){location.reload()},$scope.downloadGraph=function($event){try{for(var elements=angular.copy({nodes:Graph2.getNodes(),edges:Graph2.getEdges()}),i=0;i<elements.nodes.length;i++)delete elements.nodes[i].value.label,delete elements.nodes[i].value.labelType;var json=JSON.stringify(elements),blob=new Blob([json],{type:"application/json"}),url=URL.createObjectURL(blob);$event.target.download="graph.json",$event.target.href=url}catch(err){customAlert({message:"Graph Empty"})}},$scope.uploadGraph=function(){var input=document.querySelector("input");input.click(),input.onchange=function(){var file=input.files[0],reader=new FileReader;reader.readAsText(file),reader.onload=function(e){var graphObj=JSON.parse(e.target.result);(new Graph2).then(function(){try{for(var i=0;i<graphObj.nodes.length;i++)Graph2.addNode(graphObj.nodes[i].id,graphObj.nodes[i].value.descr,graphObj.nodes[i].value.type,graphObj.nodes[i].value.provider,graphObj.nodes[i].value.mem,graphObj.nodes[i].value.pmal,graphObj.nodes[i].value.func,graphObj.nodes[i].value.shares);for(var i=0;i<graphObj.edges.length;i++)Graph2.addEdge(graphObj.edges[i].value.from,graphObj.edges[i].value.to,graphObj.edges[i].value.label,graphObj.edges[i].value.type,graphObj.edges[i].value.shareNumber);Graph2.redesign(),$timeout(function(){bindCustomEvents(),Graph2.resize()},500)}catch(err){customAlert(err)}})},$scope.simulationRunning=!1,$scope.simulationStepRunning=!1}},$scope.isGraphInitialized=function(){return Graph2.isInitialized()},$scope.checkGraph=function(){if(Graph2.isInitialized()){new Practice;try{Practice.checkGraph(),customAlert({type:"success",message:"Everything OK"})}catch(err){customAlert(err)}}else customAlert({message:"Graph not initialized"})},$scope.runSimulation=function(){try{Graph2.resize(),new Practice,Practice.checkGraph();var modalInstance=$modal.open({templateUrl:"partial/ModalVisualizationModePartial.htm",size:"sm",controller:function($scope,$modalInstance){$scope.isCollapsed=!0,$scope.type="step",$scope.interval=500,$scope.select=function(){$modalInstance.close({type:$scope.type,intervalTime:$scope.interval})}}});modalInstance.result.then(function(selected){"auto"==selected.type?($scope.simulationRunning=!0,Practice.runIntervalSimulation(selected.intervalTime).then(function(){$scope.simulationRunning=!1})):"step"==selected.type&&(Practice.runStepSimulation(),$scope.simulationStepRunning=!0)},function(){console.log("dismiss")})}catch(err){$scope.simulationRunning=!1,customAlert(err)}},$scope.estimateRisk=function(){new Practice;for(var nodes=PracticeShapley(Practice.getNodes()),i=0;i<nodes.length;i++)Graph2.setNodeCalculatedRisk(nodes[i].id,nodes[i].risk);Graph2.redesign()},$scope.simulationStep=function(){0==Practice.simulationStep()&&($scope.simulationStepRunning=!1)},$scope.generateRuntimeTable=function(){var modalInstance=$modal.open({templateUrl:"partial/ModalRuntimeTablePartial.htm",controller:"PracticeRuntimeTableController",size:"lg",windowClass:"modalRuntimeTable"});modalInstance.result.then(function(){},function(){console.log("Chart Modal dismissed at: "+new Date)
})},$scope.generatePowerSetTable=function(){var modalInstance=$modal.open({templateUrl:"partial/ModalPowerSetCollusionPartial.htm",controller:"PracticePowerSetCollusionController",size:"lg",windowClass:"modalPowerSetCollusion"});modalInstance.result.then(function(){},function(){console.log("Chart Modal dismissed at: "+new Date)})},$scope.generateChart=function(){var modalInstance=$modal.open({templateUrl:"partial/ModalChartPartial.htm",controller:"PracticeChartsController",size:"lg",windowClass:"modalChart"});modalInstance.result.then(function(){},function(){console.log("Chart Modal dismissed at: "+new Date)})},$scope.saveModifications=function(){if($scope.modifierIsNode)try{""!=$scope.nodeDescriptionModifier.trim()&&""!=$scope.nodeGroupModifier.trim()&&""!=$scope.nodeGroupModifier.trim()&&""!=$scope.nodeTypeModifier.trim()&&(Graph2.setNodeDescription($scope.nodeNameModifier,$scope.nodeDescriptionModifier),Graph2.setNodeProvider($scope.nodeNameModifier,$scope.nodeGroupModifier),Graph2.setNodeType($scope.nodeNameModifier,$scope.nodeTypeModifier),Graph2.setNodeFunc($scope.nodeNameModifier,$scope.nodeFuncModifier),Graph2.setNodeMem($scope.nodeNameModifier,$scope.nodeMemModifier),Graph2.setNodePMAL($scope.nodeNameModifier,$scope.nodeMaliciousProbabilityModifier))}catch(err){console.log(err),customAlert({message:"Input not valid in node"})}else $scope.modifierIsEdge&&(Graph2.setEdgeLabel($scope.edgeIdModifier,$scope.edgeLabelModifier),Graph2.setEdgeType($scope.edgeIdModifier,$scope.edgeTypeModifier));Graph2.redesign()},$scope.removeElement=function(){if($scope.modifierIsNode)try{Graph2.removeNode($scope.nodeNameModifier)}catch(err){customAlert(err)}else try{Graph2.removeEdge($scope.edgeIdModifier)}catch(err){customAlert(err)}Graph2.redesign(),$timeout(function(){bindCustomEvents(),Graph2.resize()},500),$scope.showModifier(!1)}}),angular.module("PracticeSimulator").controller("PracticePowerSetCollusionController",function($scope,$modalInstance,PracticeSETOperations,Practice){function checkCollusion(arrayOfNodes,index){index-=1;for(var valuesOfNodes=[],i=0;i<arrayOfNodes.length;i++)valuesOfNodes=valuesOfNodes.concat(runTimeNodePerInstantsTable[index][arrayOfNodes[i]].MEM.array);for(var secretSharePerNodesInSubset={},i=0;i<valuesOfNodes.length;i++)"SS"==valuesOfNodes[i].comType&&("undefined"==typeof secretSharePerNodesInSubset[valuesOfNodes[i].from]?secretSharePerNodesInSubset[valuesOfNodes[i].from]=1:secretSharePerNodesInSubset[valuesOfNodes[i].from]++);for(var actualNode in secretSharePerNodesInSubset)if(runTimeNodePerInstantsTable[index][actualNode].SHARES==secretSharePerNodesInSubset[actualNode])return{problem:!0,values:valuesOfNodes};return{problem:!1,values:valuesOfNodes}}$scope.trHeader=["Nodes Coalitions"],$scope.table=[];var runTimeNodePerInstantsTable=Practice.getTableNodePerInstants(),nodi=[];for(var node in runTimeNodePerInstantsTable[0])nodi.push(node);for(var powerSet=PracticeSETOperations.PowerSet(nodi),i=0;i<runTimeNodePerInstantsTable.length;i++)$scope.trHeader.push(i);for(var tableIndex=0,i=0;i<powerSet.length;i++)powerSet[i].length>1&&($scope.table[tableIndex]instanceof Array||($scope.table[tableIndex]=[]),$scope.table[tableIndex].push({problem:!1,values:powerSet[i]}),tableIndex++);for(var i=0;i<$scope.table.length;i++)for(var j=1;j<$scope.trHeader.length;j++){var test=checkCollusion($scope.table[i][0].values,j);$scope.table[i][j]=test}$scope.exit=function(){$modalInstance.close()},$scope.getArrayOfValue=function(array){return Practice.compileMemoryToString(array)}}),angular.module("PracticeSimulator").controller("PracticeRuntimeTableController",function($scope,$modalInstance,Practice){$scope.trHeader=["#"],$scope.table=[];var runTimeNodePerInstantsTable=Practice.getTableNodePerInstants();for(var node in runTimeNodePerInstantsTable[0])$scope.trHeader.push(node);for(var i=0;i<runTimeNodePerInstantsTable.length;i++){$scope.table[i]=[];for(var j=1;j<$scope.trHeader.length;j++)$scope.table[i].push(runTimeNodePerInstantsTable[i][$scope.trHeader[j]])}$scope.getArrayOfValue=function(array){return Practice.compileMemoryToString(array)},$scope.exit=function(){$modalInstance.close()}}),angular.module("PracticeSimulator").filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}});