/*! farmacia Grunt 23-10-2014 */
angular.module("PracticeSimulator").factory("Graph2",function($q,$timeout,$window,$sanitize){function camelCase(input){return input.replace(/ (.)/g,function(match,group1){return group1.toUpperCase()})}var g,renderer,zoom,svg,layout,model,scale=.9,edgesCount=1,Graph=function(nodes,edges){angular.element(document).ready(function(){svg=d3.select("svg"),centerG=svg.append("g"),zoomG=centerG.append("g"),zoom=dagreD3.zoom.panAndZoom(d3.select("svg g g")),renderer=new dagreD3.Renderer,dagreD3.zoom(svg,zoom),layout=dagreD3.layout().nodeSep(70).rankSep(120).rankDir("LR"),g=new dagreD3.Digraph({multigraph:!0});for(var i=0;i<nodes.length;i++){var htmlTemplate="<div class='customNode'>";htmlTemplate+="<span class='type "+$sanitize(nodes[i].type)+"'> </span>",htmlTemplate+="<span class='name'>"+camelCase($sanitize(nodes[i].id))+"</span>",htmlTemplate+="<span class='description'>"+$sanitize(nodes[i].descr)+"</span>",htmlTemplate+="<span class='provider'> "+$sanitize(nodes[i].provider.toUpperCase())+"</span>",htmlTemplate+="<span class='mem'>"+$sanitize(nodes[i].mem)+("COMP"==nodes[i].type?" | "+$sanitize(nodes[i].func):"")+"</span>",htmlTemplate+="<span class='risk'>"+$sanitize(nodes[i].risk)+"</span>",htmlTemplate+="</div>",g.addNode(camelCase(nodes[i].id.trim()),{labelType:"html",label:htmlTemplate,descr:nodes[i].descr,type:nodes[i].type,provider:nodes[i].provider.toUpperCase(),mem:parseInt(nodes[i].mem),risk:parseFloat(nodes[i].risk)})}for(var i=0;i<edges.length;i++)g.addEdge(edgesCount,edges[i].u,edges[i].v,{label:edgesCount.toString()}),edgesCount++;renderer.layout(layout),model=renderer.run(g,d3.select("svg g g")),Graph.resize()}),angular.element($window).bind("resize",function(){Graph.resize()})};return Graph.resize=function(){var graphWidth=model.graph().width+5,graphHeight=model.graph().height+5,width=parseInt(svg.style("width").replace(/px/,"")),height=parseInt(svg.style("height").replace(/px/,"")),zoomScale=Math.min(width/graphWidth*scale,height/graphHeight*scale),translate=[width/2-graphWidth*zoomScale/2+10,height/2-graphHeight*zoomScale/2];zoom.translate(translate),zoom.scale(zoomScale),zoom.event(svg.transition().duration(500))},Graph.addNode=function(id,description,type,provider,mem,risk,func){try{var htmlTemplate="<div class='customNode'>";htmlTemplate+="<span class='type "+$sanitize(type)+"'> </span>",htmlTemplate+="<span class='name'>"+camelCase($sanitize(id))+"</span>",htmlTemplate+="<span class='description'>"+$sanitize(description)+"</span>",htmlTemplate+="<span class='provider'>"+$sanitize(provider.toUpperCase())+"</span>",htmlTemplate+="<span class='mem'>"+$sanitize(mem)+("COMP"==type?" | "+$sanitize(func):"")+"</span>",htmlTemplate+="<span class='risk'>"+$sanitize(risk)+"</span>",htmlTemplate+="</div>",g.addNode(camelCase(id.trim()),{labelType:"html",label:htmlTemplate,descr:description,type:type,provider:provider.toUpperCase(),mem:parseInt(mem),risk:parseFloat(risk),func:func})}catch(err){throw"Node already in graph or input not valid"}this.redesign(),$timeout(function(){Graph.resize()},500)},Graph.addEdge=function(source,target){try{g.addEdge(edgesCount,camelCase(source),camelCase(target),{label:edgesCount.toString()}),edgesCount++}catch(err){throw"Edge is already in the graph or input not valid"}this.redesign(),$timeout(function(){Graph.resize()},500)},Graph.removeNode=function(id){try{g.delNode(id)}catch(err){throw"Node not exists or input not valid"}this.redesign(),$timeout(function(){Graph.resize()},500)},Graph.removeEdge=function(id){try{g.delEdge(id)}catch(err){throw"Communication not exists"}this.redesign(),$timeout(function(){Graph.resize()},500)},Graph.redesign=function(){renderer.transition(function(selection){return selection.transition().duration(500)}),model=renderer.run(g,d3.select("svg g g"))},Graph.getElements=function(){for(var object=dagreD3.json.encode(g),i=0;i<object.nodes.length;i++)delete object.nodes[i].value.label,delete object.nodes[i].value.labelType;return delete object.type,object},Graph}),angular.module("PracticeSimulator").factory("Practice",function($q){var rawElements,nodes={},defer=$q.defer(),Practice=function(elements){rawElements=elements,console.log(elements);for(var i=0;i<elements.nodes.length;i++)nodes[elements.nodes[i].id]={ID:elements.nodes[i].id,IN:{length:function(){var key,size=0;for(key in this)this.hasOwnProperty(key)&&size++;return size-1}},OUT:{length:function(){var key,size=0;for(key in this)this.hasOwnProperty(key)&&size++;return size-1}},TYPE:elements.nodes[i].value.type,RISK:elements.nodes[i].value.risk,PROVIDER:elements.nodes[i].value.provider,MEM:elements.nodes[i].value.mem};for(var i=0;i<elements.edges.length;i++)nodes[elements.edges[i].v].IN[elements.edges[i].u]=!0,nodes[elements.edges[i].u].OUT[elements.edges[i].v]=!0;console.log(nodes)};return Practice.checkGraph=function(){console.log(nodes.nodo2.IN.length());for(key in nodes)if("COMP"==nodes[key].TYPE&&nodes[key].IN.length()<=1)throw"COMP node '"+nodes[key].ID+"' not have at least 2 nodes ingress"},Practice.runSimulation=function(){return defer.resolve(),defer.promise()},Practice}),angular.module("PracticeSimulator").controller("NetworkSimulator",function($scope,$interval,$timeout,$http,Graph2,Practice){function customAlert(message){$scope.alert=!0,$scope.alertMessage=message,$timeout(function(){$scope.alert=!1,$scope.alertMessage=""},3e3)}$scope.nameNew="",$scope.descrizioneNew="",$scope.fromNew="",$scope.toNew="",$scope.memNew=0,$scope.timeNew=0,$scope.riskNew=.1,$scope.groupOfNodeNew="",$scope.removeNodeName="",$scope.newGroupName="",$scope.newGroupDescription="",$scope.nodeTypeNew="IN",$scope.nodeTypeModifier="COMP",$scope.nodeIDModifier="",$scope.nodeDescriptionModifier="",$scope.nodeFromModifier="",$scope.nodeToModifier="",$scope.nodeGroupModifier="",$scope.simulationRunning=!1,$scope.statoBackend="Backend Down",$scope.alert=!1;var nodes=[{id:"nodo1",descr:"nodo presso aruba networks ",type:"IN",provider:"aruba",mem:"1",risk:"0.5"},{id:"nodo2",descr:"nodo presso aws ec2",type:"IN",provider:"AWS",mem:"1",risk:"0.6"},{id:"nodo3",descr:"nodo computazionale di somma",type:"COMP",provider:"telecom",mem:"0",risk:"0.7",func:"SUM"},{id:"nodo4",descr:"nodo di risoluzione",type:"RES",provider:"telecom",mem:"0",risk:"0.9"}],edges=[{u:"nodo1",v:"nodo3"},{u:"nodo2",v:"nodo3"},{u:"nodo3",v:"nodo4"}];Graph2(nodes,edges),$scope.addNode=function(){if(""!=$scope.nameNew.trim()&&""!=$scope.descrizioneNew.trim()&&""!=$scope.providerNodeNew.trim())try{Graph2.addNode($scope.nameNew.trim(),$scope.descrizioneNew.trim(),$scope.nodeTypeNew,$scope.providerNodeNew.trim(),$scope.memNew,$scope.riskNew,$scope.nodeFunctionNew),$scope.nameNew="",$scope.descrizioneNew="",$scope.providerNodeNew="",$scope.memNew=0,$scope.riskNew=.1}catch(err){customAlert(err)}else customAlert("Not compiled all input form")},$scope.addCommunication=function(){if(""!=$scope.fromNew.trim()&&""!=$scope.toNew.trim())try{Graph2.addEdge($scope.fromNew.trim(),$scope.toNew.trim()),$scope.fromNew="",$scope.toNew=""}catch(err){customAlert(err)}else customAlert("Not compiled all input form")},$scope.removeNode=function(){if(""!=$scope.removeNodeName.trim())try{Graph2.removeNode($scope.removeNodeName.trim()),$scope.removeNodeName=""}catch(err){customAlert(err)}else customAlert("Not compiled all input form")},$scope.removeEdge=function(){if(""!=$scope.removeComName.trim())try{Graph2.removeEdge($scope.removeComName.trim()),$scope.removeComName=""}catch(err){customAlert(err)}else customAlert("Not compiled all input form")},$scope.hideModifier=function(){angular.element(document.getElementById("modifier")).addClass("hide")},$scope.hideParameters=function(){angular.element(document.getElementById("parameters")).removeClass("slideRight")},$scope.showParameters=function(){angular.element(document.getElementById("parameters")).addClass("slideRight")},$scope.restartVisualizer=function(){Graph2.resize()},$scope.runSimulation=function(){try{Practice(Graph2.getElements()),Practice.checkGraph(),Practice.runSimulation()}catch(err){customAlert(err)}}});